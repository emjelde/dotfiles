#!/bin/bash

# Download and verify Gentoo Linux installation ISO
#
# https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Media

set -uex

ARCH=amd64

# Gentoo source and Portage tree mirrors, see .env.example for configuration
MIRROR=${DIST_MIRROR:-http://distfiles.gentoo.org}
RSYNC_MIRROR=${RSYNC_MIRROR:-rsync://rsync.gentoo.org/gentoo-portage}

# Gentoo automated release and ebuild repository signing keys
# https://www.gentoo.org/downloads/signatures/
WEEKLY_RELEASE_SIGNING_KEY=0x13EBBDBEDE7A12775DFDB1BABB572E0E2D182910
EBUILD_REPOSITORY_SIGNING_KEY=0xDCD05B71EAB94199527F44ACDB6B8C1F96D8BF6D

# Get the path to the latest autobuild
DIST="${MIRROR}/releases/${ARCH}/autobuilds"
ISO_PATH=$(wget -q -O- "${DIST}/latest-install-${ARCH}-minimal.txt" | tail -n 1 | cut -f 1 -d ' ')
ISO="$(basename "$ISO_PATH")"
BUILD=build
AUTOBUILD="$(dirname "$ISO_PATH")"
AUTOBUILD_DIR="${BUILD}/autobuilds/${AUTOBUILD}"
AUTOBUILD_KEYRING="${BUILD}/autobuilds/keyring"

# Download the Gentoo Linux installation ISO
mkdir --parents "$AUTOBUILD_DIR"
wget --continue --directory-prefix "${AUTOBUILD_DIR}" "${DIST}/${ISO_PATH}"{,.CONTENTS,.DIGESTS.asc}

# Set safe permissions for the homedir to suppress a warning for unsafe homedir
# permissions.
OLD_UMASK=$(umask)
umask 077
mkdir --parents "$AUTOBUILD_KEYRING"

# Download the set of keys into a keyring named 'trustedkeys.gpg', the keyring
# name is important because it's the default keyring used by gpgv.
gpg --quiet \
    --homedir "$AUTOBUILD_KEYRING" \
    --no-default-keyring \
    --keyring trustedkeys.gpg \
    --keyserver hkps.pool.sks-keyservers.net \
    --recv-keys ${WEEKLY_RELEASE_SIGNING_KEY} ${EBUILD_REPOSITORY_SIGNING_KEY}

# Verify ISO has been provided by the Gentoo Infrastructure team
gpgv --homedir "$AUTOBUILD_KEYRING" "${AUTOBUILD_DIR}/${ISO}.DIGESTS.asc"
umask "${OLD_UMASK}"

# Verify the checksum to make sure the downloaded ISO file is not corrupted
cd $AUTOBUILD_DIR
ISO_CHECKSUM="$(awk '/# SHA512 HASH/{getline; print}' ${ISO}.DIGESTS.asc)"
echo "$ISO_CHECKSUM" | sha512sum --check --status -
cd -
ISO_CHECKSUM=$(echo "$ISO_CHECKSUM" | head -n 1 | cut -f 1 -d ' ')

# Write to a configuration file used by the gentoo/gentoo.json Packer script
cat << EOF > ${BUILD}/autobuild-variables.json
{
  "arch": "${ARCH}",
  "iso_checksum": "${ISO_CHECKSUM}",
  "iso_url": "./${AUTOBUILD_DIR}/${ISO}",
  "mirror": "${MIRROR}",
  "rsync_mirror": "${RSYNC_MIRROR}",
  "stage3": "${AUTOBUILD}"
}
EOF
