#!/bin/bash

set -o errexit -o nounset -o xtrace

cp --recursive "${SOURCE}/kernel" /mnt/gentoo/tmp/
cp /dev/shm/initramfs.key /mnt/gentoo/tmp/kernel/
trap "rm --recursive /mnt/gentoo/tmp/kernel" EXIT

export LUKS_UUID="$(blkid -s UUID -o value "$LUKS_DEVICE")"

chroot /mnt/gentoo /bin/bash <<'EOF'
set -o errexit -o nounset -o xtrace

# Prepare initramfs
emerge --quiet \
   sys-fs/btrfs-progs \
   sys-fs/cryptsetup \
   sys-fs/lvm2
rc-update add lvm boot
source <(grep CONFIG_INITRAMFS_SOURCE /tmp/kernel/kernel.config)
export INITRAMFS_DIR=$(dirname $CONFIG_INITRAMFS_SOURCE)
mkdir --parents "$INITRAMFS_DIR"
envsubst '$INITRAMFS_DIR' < <(/tmp/kernel/initramfs.list) > $CONFIG_INITRAMFS_SOURCE
envsubst '$LUKS_UUID $ROOT_VOLUME_GROUP' < /tmp/kernel/initramfs.init > "${INITRAMFS_DIR}/init"
envsubst '$ROOT_DEVICE' < /tmp/kernel/initramfs.fstab > "${INITRAMFS_DIR}/fstab"
cp /tmp/kernel/initramfs.key "${INITRAMFS_DIR}/key"

# Apply custom kernel patches
mkdir --parents /etc/portage/patches/sys-kernel/gentoo-sources
cp /tmp/kernel/tuz.patch /etc/portage/patches/sys-kernel/gentoo-sources/

# Build kernel
emerge --quiet sys-kernel/gentoo-sources
cd /usr/src/linux
cp /tmp/kernel/kernel.config .config
make --quiet listnewconfig
make --quiet kvmconfig
make --quiet olddefconfig
make --quiet --jobs $CPUS
make --quiet modules_install

# Copy kernel to boot device
mkdir --parents /boot/efi/boot
cp arch/x86_64/boot/bzImage /boot/efi/boot/bootx64.efi
EOF
