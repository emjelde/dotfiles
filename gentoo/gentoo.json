{
  "description": "Gentoo Linux (iso)",
  "variables": {
    "build": "{{env `BUILD`}}",
    "cpuflags": "{{env `CPU_FLAGS`}}",
    "cpus": "{{env `CPUS`}}",
    "gentoo_keyring": "{{env `GENTOO_KEYRING`}}",
    "gentoo_mirrors": "{{env `GENTOO_MIRRORS`}}",
    "gentoo_release_mirror": "{{env `RELEASE_MIRROR`}}",
    "gentoo_rsync_mirror": "{{env `RSYNC_MIRROR`}}",
    "headless": "true",
    "iso_checksum": "",
    "iso_url": "",
    "memory": "",
    "root_volume_group": "roflpc",
    "ssh_username": "root",
    "ssh_password": "correcthorsebatterystaple",
    "stage3": "{{env `STAGE3`}}"
  },
  "builders": [{
    "type": "qemu",
    "vm_name": "gentoo-iso",
    "output_directory": "{{user `build`}}/gentoo-iso",
    "cpus": "{{user `cpus`}}",
    "memory": "{{user `memory`}}",
    "disk_interface": "ide",
    "net_device": "e1000",
    "headless": "{{user `headless`}}",
    "iso_url": "{{user `iso_url`}}",
    "iso_checksum": "{{user `iso_checksum`}}",
    "iso_checksum_type": "sha512",
    "ssh_username": "{{user `ssh_username`}}",
    "ssh_password": "{{user `ssh_password`}}",
    "boot_command": [
      "gentoo-nofb nokeymap dosshd passwd={{user `ssh_password`}}<enter>"
    ],
    "shutdown_command": "shutdown -h now"
  }],
  "provisioners": [{
    "type": "file",
    "source": "kernel",
    "destination": "/tmp"
  },{
    "type": "file",
    "source": "{{user `gentoo_keyring`}}",
    "destination": "/tmp/gentoo-release.asc"
  },{
    "type": "file",
    "source": "portage",
    "destination": "/tmp"
  },{
    "type": "shell",
    "environment_vars": [
      "BOOT_DEVICE=/dev/sda1",
      "CPUS={{user `cpus`}}",
      "CPU_FLAGS_X86={{user `cpuflags`}}",
      "GENTOO_KEYRING=/tmp/gentoo-release.asc",
      "GENTOO_MIRRORS={{user `gentoo_mirrors`}}",
      "LUKS_DEVICE=/dev/sda2",
      "RELEASE_MIRROR={{user `gentoo_release_mirror`}}",
      "ROOT_DEVICE=/dev/{{user `root_volume_group`}}/root",
      "ROOT_VOLUME_GROUP={{user `root_volume_group`}}",
      "RSYNC_MIRROR={{user `gentoo_rsync_mirror`}}",
      "SOURCE=/tmp",
      "STAGE3={{user `stage3`}}",
      "SWAP_DEVICE=/dev/{{user `root_volume_group`}}/swap"
    ],
    "scripts": [
      "gentoo/01-partition",
      "gentoo/02-stage3",
      "gentoo/03-mounts",
      "gentoo/04-resolvconf",
      "gentoo/05-portage",
      "gentoo/06-timezone",
      "gentoo/07-fstab",
      "gentoo/08-kernel",
      "gentoo/09-network",
      "gentoo/10-system"
    ]
  }]
}
