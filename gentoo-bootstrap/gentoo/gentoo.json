{
  "description": "Stage 3 Gentoo Installation (VirtualBox)",
  "variables": {
    "headless": "true",
    "ssh_username": "root",
    "ssh_password": "secret"
  },
  "builders": [{
    "type": "virtualbox-iso",
    "boot_command": [
      "gentoo-nofb<enter>",
      "<wait10>",
      "<enter>",
      "<wait10>",
      "passwd {{user `ssh_username`}}<enter>",
      "{{user `ssh_password`}}<enter>",
      "{{user `ssh_password`}}<enter>",
      "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config<enter>",
      "sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config<enter>",
      "/etc/init.d/sshd start<enter>"
    ],
    "boot_wait": "5s",
    "guest_os_type": "Gentoo_64",
    "guest_additions_mode": "disable",
    "headless": "{{user `headless`}}",
    "iso_url": "{{user `iso_url`}}",
    "iso_checksum": "{{user `iso_checksum`}}",
    "iso_checksum_type": "sha512",
    "output_directory": "build/gentoo-iso",
    "ssh_username": "{{user `ssh_username`}}",
    "ssh_password": "{{user `ssh_password`}}",
    "shutdown_command": "shutdown -h now",
    "vm_name": "gentoo-iso",
    "vboxmanage": [
      [ "modifyvm", "{{.Name}}", "--cpus", "{{user `cpus`}}" ],
      [ "modifyvm", "{{.Name}}", "--memory", "{{user `memory`}}" ]
    ]
  }],
  "provisioners": [{
    "type": "file",
    "source": "kernel",
    "destination": "/tmp"
  },{
    "type": "file",
    "source": "build/autobuilds/keyring",
    "destination": "/tmp"
  },{
    "type": "file",
    "source": "portage",
    "destination": "/tmp"
  },{
    "type": "shell",
    "environment_vars": [
      "ARCH={{user `arch`}}",
      "AUTOBUILD_KEYRING=/tmp/keyring",
      "BOOT_DEVICE=/dev/sda1",
      "CPU_FLAGS_X86={{user `cpuflags`}}",
      "CPUS={{user `cpus`}}",
      "MIRROR={{user `mirror`}}",
      "ROOT_DEVICE=/dev/sda3",
      "RSYNC_MIRROR={{user `rsync_mirror`}}",
      "SOURCE=/tmp",
      "STAGE3={{user `stage3`}}",
      "SWAP_DEVICE=/dev/sda2"
   ],
    "scripts": [
      "gentoo/01-partition",
      "gentoo/02-stage3",
      "gentoo/03-mounts",
      "gentoo/04-resolvconf",
      "gentoo/05-portage",
      "gentoo/06-timezone",
      "gentoo/07-fstab",
      "gentoo/08-kernel",
      "gentoo/09-network",
      "gentoo/10-system"
    ]
  }]
}
