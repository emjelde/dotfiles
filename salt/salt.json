{
  "description": "Gentoo Linux (salt)",
  "variables": {
    "build": "{{env `BUILD`}}",
    "cpus": "{{env `CPUS`}}",
    "headless": "true",
    "memory": "",
    "minion_id": "roflpc",
    "ssh_username": "root",
    "ssh_password": "correcthorsebatterystaple"
  },
  "builders": [{
    "type": "qemu",
    "vm_name": "gentoo-salt",
    "output_directory": "{{user `build`}}/gentoo-salt",
    "disk_image": "true",
    "cpus": "{{user `cpus`}}",
    "memory": "{{user `memory`}}",
    "disk_interface": "ide",
    "net_device": "e1000",
    "qemuargs": [
       ["-drive", "if=pflash,format=raw,readonly,file=/usr/share/edk2-ovmf/OVMF_CODE.fd"]
    ],
    "headless": "{{user `headless`}}",
    "iso_url": "{{user `build`}}/gentoo-iso/gentoo-iso",
    "iso_checksum_type": "none",
    "ssh_username": "{{user `ssh_username`}}",
    "ssh_password": "{{user `ssh_password`}}",
    "shutdown_command": "shutdown -h now"
  }],
  "provisioners": [{
    "type": "shell-local",
    "environment_vars": [
      "PILLAR_DIR={{user `build`}}/pillar",
      "SALT_DIR={{user `build`}}/salt",
      "SALT_KEYS={{user `build`}}/salt-keys"
    ],
    "inline": [
      "salt/salt-top --force",
      "salt/salt-pillar"
    ]
  },{
    "type": "shell",
    "inline": [
       "mkdir /etc/salt",
       "mkdir /srv"
    ]
  },{
    "type": "file",
    "source": "salt",
    "destination": "/tmp"
  },{
    "type": "file",
    "generated": "true",
    "source": "{{user `build`}}/pillar",
    "destination": "/srv"
  },{
    "type": "file",
    "generated": "true",
    "source": "{{user `build`}}/salt",
    "destination": "/srv"
  },{
    "type": "file",
    "generated": "true",
    "source": "{{user `build`}}/salt-keys",
    "destination": "/etc/salt/gpgkeys"
  },{
    "type": "shell",
    "environment_vars": [
      "MINION_ID={{user `minion_id`}}",
      "SOURCE=/tmp/salt"
    ],
    "inline": [
       "cd /tmp",
       "salt/salt-apply"
    ]
  }]
}
