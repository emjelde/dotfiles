#!/bin/bash

# Prepare the packer salt build by collecting all salt states. This is done to
# manage the desired directory structure.

set -o errexit -o nounset

# Copy salt states into build

SALT_DIR="${SALT_DIR-${BUILD}/salt}"
DOTFILES="${SALT_DIR}/dotfiles"

rm -rf "$SALT_DIR"
mkdir --parents "${DOTFILES}"

echo "dotfiles"
echo "include:" > "${DOTFILES}/init.sls"

add_to_init() {
   echo "  $1"
   echo "  - .$1" >> "${DOTFILES}/init.sls"
}

# Copies the entire state directory ignoring files listed in .saltignore
statedir() {
   if [ -f "${1}/.saltignore" ]; then
      GLOBIGNORE=$(tr '\n' ':' < <(sed "s/.*/${1}\/&/" < "${1}/.saltignore"))
   else
      GLOBIGNORE=.
   fi
   cp --parents --recursive "$1"/* "${DOTFILES}"
   unset GLOBIGNORE
   add_to_init "$1"
}

# Copies an individual salt state file
statefile() {
   cp --parents "${1/\./\/}.sls" "${DOTFILES}"
   add_to_init "$1"
}

statedir portage
statedir awesome
statedir bash
statedir deluge
statedir firefox
statedir git
statedir gpg
statedir htop
statedir java
statedir pass
statedir salt
statedir smartcard
statedir ssh
statefile 'system.fonts'
statefile 'system.system'
statefile 'system.time'
statedir thunderbird
statedir tmux
statedir urxvt
statedir vim
statedir x11

cat > "${SALT_DIR}/top.sls" <<'EOF'
base:
  '*':
    - dotfiles
EOF
