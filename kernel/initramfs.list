#!/bin/bash

# Generate a file list which describes files to be included into the initramfs.
#
# This file list is processed by the Linux kernel utility
# /usr/src/linux/usr/gen_init_cpio.
#
# # a comment
# file  <name> <location> <mode> <uid> <gid> [<hard links>]
# dir   <name> <mode>     <uid>  <gid>
# nod   <name> <mode>     <uid>  <gid> <dev_type> <maj> <min>
#
# <name>       name of the file/dir/nod/etc in the archive
# <location>   location of the file in the current filesystem
#              expands shell variables quoted with ${}
# <mode>       mode/permissions of the file
# <uid>        user id (0=root)
# <gid>        group id (0=root)
# <dev_type>   device type (b=block, c=character)
# <maj>        major number of nod
# <min>        minor number of nod
# <hard links> space separated list of other links to file

set -ue

cat << 'EOF'
dir /bin 0755 0 0
dir /dev 0755 0 0
dir /etc 0755 0 0
dir /lib64 0755 0 0
dir /mnt 0755 0 0
dir /new-root 0755 0 0
dir /proc 0755 0 0
dir /run 0755 0 0
dir /sbin 0755 0 0
dir /sys 0755 0 0
dir /usr/lib64 0755 0 0

nod /dev/console 0600 0 0 c 5 1
nod /dev/mem 0600 0 0 c 1 1
nod /dev/null 0600 0 0 c 1 3
nod /dev/random 0600 0 0 c 1 8
nod /dev/tty 0600 0 0 c 5 0
nod /dev/tty1 0600 0 0 c 4 1
nod /dev/urandom 0600 0 0 c 1 9
nod /dev/zero 0600 0 0 c 1 5

file /etc/fstab ${INITRAMFS_DIR}/fstab 0644 0 0
file init ${INITRAMFS_DIR}/init 0755 0 0
EOF

# Add the following commands and their dependencies to the list.
# The lddtree command belongs to app-misc/pax-utils and is already provided in
# stage3.
(
lddtree -l /bin/bash
lddtree -l /bin/cat
lddtree -l /bin/mount
lddtree -l /bin/sleep
lddtree -l /sbin/blkid
lddtree -l /sbin/btrfs
lddtree -l /sbin/lvm
lddtree -l /sbin/switch_root
) | sort --unique \
  | sed 's/\(.*\)/file \1 \1 0755 0 0/'
