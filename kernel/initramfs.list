#!/bin/bash

# Generate a file list to include files into the initramfs using the Linux
# kernel utility /usr/src/linux/usr/gen_init_cpio.

set -ue

# Add the following commands and their dependencies to the list.
# The lddtree command belongs to app-misc/pax-utils and is already provided in
# stage3.
lddtree=$(echo "$(
lddtree -l /bin/bash
lddtree -l /bin/cat
lddtree -l /bin/mount
lddtree -l /bin/sleep
lddtree -l /sbin/blkid
lddtree -l /sbin/btrfs
lddtree -l /sbin/cryptsetup
lddtree -l /sbin/lvm
lddtree -l /sbin/switch_root
)" | sort --unique)

# dir <name> <mode> <uid> <gid>
#
# <name>     name of the dir in the archive
# <mode>     mode/permissions of the file
# <uid>      user id (0=root)
# <gid>      group id (0=root)
(
echo "$lddtree" | xargs dirname

cat << 'EOF'
/dev
/etc
/mnt
/new-root
/proc
/run
/sys
/usr
EOF
) | sort --unique \
  | sed 's/\(.*\)/dir \1 0755 0 0/'

# nod <name> <mode> <uid> <gid> <dev_type> <maj> <min>
#
# <name>     name of the nod in the archive
# <mode>     mode/permissions of the file
# <uid>      user id (0=root)
# <gid>      group id (0=root)
# <dev_type> device type (b=block, c=character)
# <maj>      major number of nod
# <min>      minor number of nod
cat << 'EOF'

nod /dev/console 0600 0 0 c 5 1
nod /dev/mem 0600 0 0 c 1 1
nod /dev/null 0600 0 0 c 1 3
nod /dev/random 0600 0 0 c 1 8
nod /dev/tty 0600 0 0 c 5 0
nod /dev/tty1 0600 0 0 c 4 1
nod /dev/urandom 0600 0 0 c 1 9
nod /dev/zero 0600 0 0 c 1 5
EOF

# file <name> <location> <mode> <uid> <gid>
#
# <name>     name of the file in the archive
# <location> location of the file in the current filesystem
#            expands shell variables quoted with ${}
# <mode>     mode/permissions of the file
# <uid>      user id (0=root)
# <gid>      group id (0=root)
cat << 'EOF'

file /etc/fstab ${INITRAMFS_DIR}/fstab 0644 0 0
file /etc/key ${INITRAMFS_DIR}/key 0600 0 0
file init ${INITRAMFS_DIR}/init 0755 0 0

EOF
echo "$lddtree" | sed 's/\(.*\)/file \1 \1 0755 0 0/'
